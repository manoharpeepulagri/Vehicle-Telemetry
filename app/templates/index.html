<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vehicle Live Telemetry</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#06b6d4;
      --success:#16a34a; --warn:#f59e0b; --danger:#dc2626;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial;color:#e6eef6;background:linear-gradient(180deg,#071022 0%, #071a2a 100%);}
    .app{display:grid;grid-template-columns:1fr 360px;grid-template-rows:56px 1fr;grid-template-areas:"header header" "map sidebar";height:100vh;gap:12px;padding:12px;box-sizing:border-box}
    
    header{grid-area:header;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-radius:8px;background:var(--glass);backdrop-filter:blur(6px)}
    header h1{font-size:18px;margin:0; display: flex; align-items: center; gap: 10px;}
    
    select.vehicle-select {
        background: var(--card);
        color: white;
        border: 1px solid var(--muted);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
    }

    #map{grid-area:map;border-radius:8px;overflow:hidden}
    aside{grid-area:sidebar;padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 6px 18px rgba(2,6,23,0.6);display:flex;flex-direction:column;gap:12px}
    .soc-card{display:flex;flex-direction:column;gap:8px}
    .soc-bar{height:18px;background:#102234;border-radius:10px;overflow:hidden}
    .soc-fill{height:100%;width:0%;background:var(--success);transition:width .4s ease,background .4s}
    .metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .metric{background:var(--card);padding:10px;border-radius:8px;color:var(--muted);display:flex;flex-direction:column}
    .metric .value{font-size:18px;color:#fff;font-weight:600}
    .muted{color:var(--muted);font-size:12px}
    .footer{margin-top:auto;font-size:12px;color:var(--muted);}
    .map-controls{position:absolute;bottom:20px;left:20px;display:flex;gap:8px;z-index:1000}
    .map-btn{padding:10px 14px;background:#06b6d4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;transition:background .2s}
    .map-btn:hover{background:#0891b2}
    
    .vehicle-marker { background: transparent; border: none; }
    
    @media (max-width:900px){
      .app{grid-template-columns:1fr;grid-template-areas:"header" "map" "sidebar"}
      aside{order:3}
      .map-controls{bottom:12px;left:12px}
      .map-btn{padding:8px 12px;font-size:12px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>
        Vehicle: 
        <select id="vehicleSelect" class="vehicle-select">
            <option value="nandi_1" selected>Nandi 1</option>
            <option value="nandi_2">Nandi 2</option>
        </select>
      </h1>
      <div id="status" class="muted">Connecting‚Ä¶</div>
    </header>

    <div id="map">
      <div class="map-controls">
        <button id="focusBtn" class="map-btn" title="Zoom to vehicle">üìç Focus</button>
        <button id="satelliteBtn" class="map-btn" title="Toggle satellite view">üõ∞Ô∏è Satellite</button>
        <button id="navBtn" class="map-btn" title="Get directions">üöó Navigate</button>
      </div>
    </div>

    <aside>
      <div class="soc-card">
        <div class="muted">State of Charge</div>
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <div class="soc-bar"><div id="socFill" class="soc-fill"></div></div>
          </div>
          <div style="width:56px;text-align:right;font-weight:700;color:#fff" id="socText">0%</div>
        </div>
        <div class="muted" id="socHint">BatteryEnergy: <span id="batteryEnergy">0</span></div>
      </div>

      <div class="metrics">
        <div class="metric">
          <div class="muted">Speed</div>
          <div class="value" id="speed">0 km/h</div>
        </div>
        <div class="metric">
          <div class="muted">RPM</div>
          <div class="value" id="rpm">0</div>
        </div>
        <div class="metric">
          <div class="muted">Drive Mode</div>
          <div class="value" id="drive">Neutral</div>
        </div>
        <div class="metric">
          <div class="muted">Odometer</div>
          <div class="value" id="odo">0 km</div>
        </div>
        <div class="metric">
          <div class="muted">Acceleration</div>
          <div class="value" id="acc">0</div>
        </div>
        <div class="metric">
          <div class="muted">Spray Pump</div>
          <div class="value" id="spray">Off</div>
        </div>
      </div>

      <div class="footer">Last update: <span id="lastUpdate">‚Äî</span></div>
    </aside>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {zoomControl:true}).setView([16.05,80.35],15);
    
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'¬© OpenStreetMap'});
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19, attribution:'¬© Esri'});
    
    osmLayer.addTo(map);
    let isSatellite = false;
    
    const vehicleSvg = `
      <svg width="40" height="40" viewBox="0 0 24 24" fill="#06b6d4" stroke="#ffffff" stroke-width="2" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transform-origin: center;">
        <path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" />
      </svg>
    `;

    const vehicleIcon = L.divIcon({
      className: 'vehicle-marker',
      html: `<div id="vehicle-arrow" style="transition: transform 0.3s ease;">${vehicleSvg}</div>`,
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });

    let marker = null; 
    let polyline = L.polyline([], {color:'#06b6d4', weight: 4, opacity: 0.7}).addTo(map);
    let currentLatLng = null;
    let ws = null;
    let wsKeepAlive = null;

    function setStatus(text, color){
      const el = document.getElementById('status'); el.textContent = text; if(color) el.style.color = color; else el.style.color='';
    }

    function resetDashboard() {
        if(marker) { map.removeLayer(marker); marker = null; }
        polyline.setLatLngs([]);
        currentLatLng = null;
        document.getElementById('speed').textContent = "0 km/h";
        // ... reset other fields ...
    }

    async function connectVehicle(vehicleId) {
        if (ws) {
            ws.close();
            clearInterval(wsKeepAlive);
        }

        setStatus(`Loading history for ${vehicleId}‚Ä¶`, '#fbbf24');

        // 1. Fetch History First
        try {
            const res = await fetch(`/history/${vehicleId}`);
            const histData = await res.json();
            if (histData.path && histData.path.length > 0) {
                polyline.setLatLngs(histData.path);
                // Center map on the last known point
                const lastPoint = histData.path[histData.path.length - 1];
                map.setView(lastPoint, 16);
                
                // Add marker at last known location immediately
                marker = L.marker(lastPoint, {icon: vehicleIcon}).addTo(map);
                currentLatLng = lastPoint;
            }
        } catch (e) {
            console.error("Failed to load history", e);
        }

        // 2. Open WebSocket
        const wsProto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
        ws = new WebSocket(`${wsProto}//${location.host}/ws/vehicle/${vehicleId}`);

        ws.addEventListener('open', ()=>{ 
            setStatus(`Connected (${vehicleId})`, 'lightgreen');
            wsKeepAlive = setInterval(()=>{ if(ws.readyState===WebSocket.OPEN) ws.send('ping'); }, 30000);
        });

        ws.addEventListener('close', ()=> setStatus('Disconnected','orange'));
        ws.addEventListener('error', ()=> setStatus('Error','red'));
        ws.addEventListener('message', handleMessage);
    }

    // --- HELPER: Case Insensitive Getter ---
    function getValueInsensitive(obj, ...keys) {
      if (!obj) return undefined;
      for (const k of keys) { if (k in obj) return obj[k]; }
      const objKeys = Object.keys(obj);
      const targetKeys = keys.map(k => k.toLowerCase());
      for (const k of objKeys) { if (targetKeys.includes(k.toLowerCase())) return obj[k]; }
      return undefined;
    }

    function safeGet(obj, ...keys){
      for(const k of keys){ if(obj && (k in obj)) return obj[k]; }
      return undefined;
    }

    function handleMessage(ev) {
      try{
        const data = JSON.parse(ev.data);
        const gnss = data.gnss || data.location || {};
        const sig = data.signals || data || {};
        const heading = data.vehicle_direction_deg || 0;

        const lat = safeGet(gnss,'lat','latitude');
        const lon = safeGet(gnss,'lon','longitude');
        
        if(typeof lat==='number' && typeof lon==='number'){
          const ll=[lat,lon];
          currentLatLng = ll;
          
          if(!marker){ 
            marker = L.marker(ll, {icon: vehicleIcon}).addTo(map); 
            map.setView(ll,16); 
          } else { 
            marker.setLatLng(ll); 
          }
          
          const arrowEl = document.getElementById('vehicle-arrow');
          if(arrowEl) arrowEl.style.transform = `rotate(${heading}deg)`;

          polyline.addLatLng(ll);
        }

        const soc = getValueInsensitive(sig, 'RSOC', 'ActualSocPercentage', 'SOC');
        const speed = safeGet(sig,'Speed','speed');
        const batteryEnergy = safeGet(sig,'BatteryEnergy','Battery_Energy');
        const rpm = safeGet(sig,'RPM');
        const acc = safeGet(sig,'Vehicle_Acceleration','Acceleration');
        const spray = safeGet(sig,'Spray_Pump_Status');
        const odo = safeGet(sig,'Main_Odometer','Odometer');

        updateSOC(soc);
        document.getElementById('batteryEnergy').textContent = (batteryEnergy != null) ? Number(batteryEnergy).toFixed(2) : '-';
        document.getElementById('speed').textContent = Number(speed ?? 0).toFixed(2) + ' km/h';
        document.getElementById('rpm').textContent = Number(rpm ?? 0).toFixed(2);
        document.getElementById('acc').textContent = Number(acc ?? 0).toFixed(2);
        document.getElementById('spray').textContent = (spray==1)?'On':'Off';
        document.getElementById('odo').textContent = Number(odo ?? 0).toFixed(2) + ' km';

        let driveMode = 'Unknown';
        if(safeGet(sig,'Drive_Forward')==1) driveMode='Forward';
        else if(safeGet(sig,'Drive_Reverse')==1) driveMode='Reverse';
        else if(safeGet(sig,'Drive_Neutral')==1) driveMode='Neutral';
        document.getElementById('drive').textContent = driveMode;

        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      }catch(e){ console.warn('invalid payload', e); }
    }

    const vehicleSelect = document.getElementById('vehicleSelect');
    connectVehicle(vehicleSelect.value);
    
    vehicleSelect.addEventListener('change', (e) => {
        resetDashboard();
        connectVehicle(e.target.value);
    });

    document.getElementById('focusBtn').addEventListener('click', ()=>{
      if(currentLatLng) map.setView(currentLatLng, 17);
    });

    document.getElementById('navBtn').addEventListener('click', () => {
      if (currentLatLng) {
        const [lat, lon] = currentLatLng;
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`, '_blank');
      } else { alert("Waiting for vehicle location data..."); }
    });

    document.getElementById('satelliteBtn').addEventListener('click', ()=>{
      const btn = document.getElementById('satelliteBtn');
      if(isSatellite){
        map.removeLayer(satelliteLayer); map.addLayer(osmLayer);
        btn.style.background = '#06b6d4'; btn.textContent = 'üõ∞Ô∏è Satellite';
        isSatellite = false;
      } else {
        map.removeLayer(osmLayer); map.addLayer(satelliteLayer);
        btn.style.background = '#f59e0b'; btn.textContent = 'üó∫Ô∏è Map';
        isSatellite = true;
      }
    });

    function updateSOC(val){
      const v = Number(val) || 0; const pct = Math.max(0,Math.min(100,Math.round(v)));
      const fill = document.getElementById('socFill'); const text = document.getElementById('socText');
      fill.style.width = pct + '%'; text.textContent = pct + '%';
      if(pct>=75) fill.style.background='var(--success)'; else if(pct>=40) fill.style.background='var(--warn)'; else fill.style.background='var(--danger)';
    }
  </script>
</body>
</html>