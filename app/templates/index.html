<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Vehicle Fleet Manager</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#06b6d4;
      --success:#16a34a; --warn:#f59e0b; --danger:#dc2626;
      --glass: rgba(255,255,255,0.03);
    }
    
    html, body {
        height: 100%; height: 100dvh; 
        margin: 0; padding: 0;
        font-family: Inter, system-ui, Segoe UI, Arial;
        color: #e6eef6;
        background: linear-gradient(180deg, #071022 0%, #071a2a 100%);
        overflow: hidden;
    }

    .app {
        display: grid;
        grid-template-columns: 1fr 360px;
        grid-template-rows: 60px 1fr;
        grid-template-areas: "header header" "map sidebar";
        height: 100%;
        gap: 12px;
        padding: 12px;
        box-sizing: border-box;
    }
    
    header {
        grid-area: header;
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 12px; border-radius: 8px;
        background: var(--glass); backdrop-filter: blur(6px);
        min-height: 56px;
    }
    
    header h1 {
        font-size: 16px; margin: 0; display: flex; align-items: center; gap: 8px;
        flex-wrap: wrap;
    }
    
    select.vehicle-select {
        background: var(--card); color: white; border: 1px solid var(--muted);
        padding: 6px 8px; border-radius: 4px; font-size: 14px; cursor: pointer;
        max-width: 120px;
    }
    
    .reconnect-btn {
        background: var(--danger); color: white; border: none; width: 36px; height: 36px; border-radius: 6px; 
        cursor: pointer; font-size: 20px; line-height: 1; font-weight: bold; display: none; align-items: center; justify-content: center;
    }
    .reconnect-btn:hover {background: #b91c1c; transform: rotate(45deg);}
    .reconnect-btn.visible {display: inline-flex;}
    
    .diag-btn {
        background: #374151; color: white; border: 1px solid var(--muted); padding: 10px; border-radius: 6px;
        cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; margin-top: auto;
        transition: background 0.2s;
    }
    .diag-btn:hover { background: #4b5563; }

    .download-btn {
        background: #065f46; color: white; border: 1px solid var(--muted); padding: 10px; border-radius: 6px;
        cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%;
        transition: background 0.2s;
    }
    .download-btn:hover { background: #047857; }

    #map {
        grid-area: map; border-radius: 8px; overflow: hidden; position: relative; 
        background: #000; z-index: 1;
        min-height: 300px;
    }
    
    #map.pseudo-fullscreen {
        position: fixed !important;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw !important; height: 100dvh !important;
        z-index: 99999 !important;
        border-radius: 0 !important;
        margin: 0 !important;
    }
    
    aside {
        grid-area: sidebar; padding: 12px; border-radius: 8px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
        box-shadow: 0 6px 18px rgba(2,6,23,0.6);
        display: flex; flex-direction: column; gap: 12px; 
        overflow-y: auto; -webkit-overflow-scrolling: touch;
    }
    
    .card-group {background: var(--card); padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 6px;}
    .card-title {font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px;}
    
    .soc-bar {height: 16px; background: #102234; border-radius: 10px; overflow: hidden; margin-top: 4px;}
    .soc-fill {height: 100%; width: 0%; background: var(--success); transition: width .4s ease;}
    
    .metrics {display: grid; grid-template-columns: 1fr 1fr; gap: 8px;}
    .metric {background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; color: var(--muted); display: flex; flex-direction: column;}
    .metric .value {font-size: 15px; color: #fff; font-weight: 600; margin-top: 2px;}
    
    .map-controls {position: absolute; bottom: 20px; left: 20px; display: flex; gap: 8px; z-index: 1000;}
    .map-btn {padding: 8px 12px; background: #06b6d4; color: #fff; border: none; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer;}
    .map-btn:hover {background: #0891b2;}
    
    .map-tools {position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 1000;}
    .tool-btn {width: 36px; height: 36px; border-radius: 6px; border: none; background: rgba(0,0,0,0.6); color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); cursor: pointer;}
    .tool-btn:hover {background: rgba(0,0,0,0.8);}
    
    .vehicle-marker { background: transparent; border: none; }

    /* Status Indicator Animations */
    @keyframes blink-green {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes blink-orange {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    @keyframes blink-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-indicator.connected {
      background: rgba(22, 163, 74, 0.2);
      color: #4ade80;
      border: 1px solid rgba(22, 163, 74, 0.4);
    }
    .status-indicator.connected .status-dot {
      background: #4ade80;
      animation: blink-green 1.5s infinite;
    }

    .status-indicator.disconnected {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.4);
    }
    .status-indicator.disconnected .status-dot {
      background: #fbbf24;
      animation: blink-orange 1.5s infinite;
    }

    .status-indicator.offline {
      background: rgba(220, 38, 38, 0.2);
      color: #f87171;
      border: 1px solid rgba(220, 38, 38, 0.4);
    }
    .status-indicator.offline .status-dot {
      background: #f87171;
      animation: blink-red 1.5s infinite;
    }

    .status-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .status-time {
      font-size: 10px;
      opacity: 0.8;
      font-weight: 400;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        grid-template-areas: "header" "map" "sidebar";
        gap: 8px; padding: 8px;
      }
      #map { min-height: 40vh; }
      aside { max-height: 45vh; overflow-y: auto; }
      header h1 { font-size: 14px; width: 100%; justify-content: space-between; }
      .status-indicator { font-size: 10px; padding: 4px 8px; }
    }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-overlay.open { display: flex; }
    .modal-card { background: #111827; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; border-radius: 12px; border: 1px solid #374151; display: flex; flex-direction: column; }
    .modal-header { padding: 12px 16px; border-bottom: 1px solid #374151; display: flex; justify-content: space-between; align-items: center; background: #1f2937; position: sticky; top: 0; }
    .modal-body { padding: 16px; display: grid; grid-template-columns: 1fr; gap: 12px; }
    .diag-group { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; border: 1px solid #374151; }
    .diag-group h3 { margin: 0 0 8px 0; font-size: 13px; color: var(--accent); border-bottom: 1px solid #374151; padding-bottom: 4px; }
    .diag-item { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .diag-val { color: #fff; font-family: monospace; font-weight: bold; }
    .close-modal { background: none; border: none; color: #fff; font-size: 24px; padding: 0 8px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>
        <div style="display:flex; align-items:center; gap:6px;">
            Vehicle: 
            <select id="vehicleSelect" class="vehicle-select">
                <option value="nandi_1" selected>Nandi 1</option>
                <option value="nandi_2">Nandi 2</option>
            </select>
        </div>
      </h1>
      <div style="display:flex; gap:12px; align-items:center;">
        <button id="reconnectBtn" class="reconnect-btn" title="Reconnect">‚Üª</button>
        <div id="statusIndicator" class="status-indicator disconnected">
          <span class="status-dot"></span>
          <div class="status-info">
            <span id="statusText">Connecting...</span>
            <span class="status-time" id="statusTime"></span>
          </div>
        </div>
      </div>
    </header>

    <div id="map">
      <div class="map-tools">
        <button id="screenshotBtn" class="tool-btn" title="Screenshot">üì∑</button>
        <button id="fullscreenBtn" class="tool-btn" title="Fullscreen">‚õ∂</button>
      </div>

      <div class="map-controls">
        <button id="focusBtn" class="map-btn">üìç Focus</button>
        <button id="satelliteBtn" class="map-btn">üõ∞Ô∏è Sat</button>
        <button id="navBtn" class="map-btn">üöó Nav</button>
      </div>
    </div>

    <aside>
      <div class="card-group">
        <div class="card-title">Power System</div>
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <div class="soc-bar"><div id="socFill" class="soc-fill"></div></div>
          </div>
          <div style="font-weight:700;color:#fff" id="socText">‚Äì</div>
        </div>
        <div class="muted" style="margin-top: 4px; font-size: 11px; text-align: right;">
            Energy: <span id="batEnergy" style="color: #fff; font-weight: bold;">‚Äì</span> Wh
        </div>
      </div>

      <div class="card-group">
        <div class="card-title">Configuration</div>
        <div id="modeBadge" style="padding: 4px; border-radius: 4px; font-size: 13px; font-weight: bold; text-align: center; background: #1e293b; color: #fff;">IDLE</div>
        <div class="metrics">
             <div class="metric"><span style="font-size:10px">Gear</span><div class="value" id="gearText">‚Äì</div></div>
             <div class="metric"><span style="font-size:10px">Spray</span><div class="value" id="sprayText">‚Äì</div></div>
        </div>
      </div>

      <div class="metrics">
        <div class="metric"><span style="font-size:10px">Speed</span><div class="value" id="speed">‚Äì km/h</div></div>
        <div class="metric"><span style="font-size:10px">RPM</span><div class="value" id="rpm">‚Äì</div></div>
        
        <div class="metric"><span style="font-size:10px">Total Dist.</span><div class="value" id="gpsDist">‚Äì km</div></div>
        <div class="metric" style="border: 1px solid rgba(22, 163, 74, 0.4);">
            <span style="font-size:10px; color:#4ade80">Spray Dist.</span>
            <div class="value" id="sprayDist" style="color:#4ade80">‚Äì km</div>
        </div>

        <div class="metric"><span style="font-size:10px">Odometer</span><div class="value" id="odo">‚Äì km</div></div>
        <div class="metric"><span style="font-size:10px">Drive</span><div class="value" id="drive">‚Äì</div></div>
      </div>

      <button id="openDiagBtn" class="diag-btn">üìä Open Diagnostics</button>
      <button id="downloadBtn" class="download-btn">üì• Download CSV</button>

      <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
        <div class="card-group">
          <div class="card-title">Land Coverage</div>
          <button id="landMeasureBtn" class="diag-btn" style="background: #374151; margin-bottom: 8px;">üìê Measure Land</button>
          <div style="display: flex; gap: 6px;">
            <button id="landUndoBtn" class="diag-btn" style="flex: 1; background: #7c3aed; font-size: 12px;" disabled>‚Ü∂ Undo</button>
            <button id="landClearBtn" class="diag-btn" style="flex: 1; background: #dc2626; font-size: 12px;" disabled>üóëÔ∏è Clear</button>
          </div>
        </div>

        <div id="landStatsContainer" class="card-group" style="display: none; margin-top: 8px;">
          <div class="card-title">Land Measured</div>
          <div style="background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px; margin-bottom: 6px;">
            <div style="font-size: 10px; color: #9aa4b2;">Area (acres)</div>
            <div style="font-size: 14px; color: #4ade80; font-weight: 700;" id="landAreaVal">0 acres</div>
            <small style="font-size: 9px; color: #6b7280; display: block; margin-top: 2px;" id="landAreaSqm">0 m¬≤</small>
          </div>
          
          <div style="background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px;">
            <div style="font-size: 10px; color: #9aa4b2;">Points</div>
            <div style="font-size: 14px; color: #fff; font-weight: 700;" id="landPointsVal">0</div>
          </div>

          <div style="margin-top: 8px; max-height: 150px; overflow-y: auto;">
            <div id="landPointsList"></div>
          </div>
        </div>
      </div>

      <div class="footer" style="font-size:10px; margin-top: 10px; color: var(--muted); text-align: center;">
        Last update: <span id="lastUpdate">‚Äì</span>
      </div>
    </aside>
  </div>

  <div id="diagModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div style="font-weight:bold; color:#fff; font-size:16px;">Diagnostics</div>
            <button id="closeDiagBtn" class="close-modal">√ó</button>
        </div>
        <div class="modal-body">
            <div class="diag-group">
                <h3>Motor</h3>
                <div class="diag-item"><span class="diag-label">Temp (¬∞C)</span><span class="diag-val" id="d_mtrTemp">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Motor RPM</span><span class="diag-val" id="d_mtrRpm">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">RMS Current (A)</span><span class="diag-val" id="d_rmsCurr">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Efficiency</span><span class="diag-val" id="d_mtrEff">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Acceleration</span><span class="diag-val" id="d_acc">‚Äì</span></div>
            </div>
            <div class="diag-group">
                <h3>Controller</h3>
                <div class="diag-item"><span class="diag-label">Temp (¬∞C)</span><span class="diag-val" id="d_ctrlTemp">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Voltage (V)</span><span class="diag-val" id="d_ctrlVolt">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Current (A)</span><span class="diag-val" id="d_ctrlCurr">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">DC Voltage (V)</span><span class="diag-val" id="d_dcVolt">‚Äì</span></div>
            </div>
            <div class="diag-group">
                <h3>Battery</h3>
                <div class="diag-item"><span class="diag-label">Voltage (V)</span><span class="diag-val" id="d_batVolt">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Current (A)</span><span class="diag-val" id="d_batCurr">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Net Current (A)</span><span class="diag-val" id="d_netCurr">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Energy (Wh)</span><span class="diag-val" id="d_energy">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">SOC (%)</span><span class="diag-val" id="d_soc">‚Äì</span></div>
            </div>
            <div class="diag-group">
                <h3>Hydraulics</h3>
                <div class="diag-item"><span class="diag-label">Motor Temp (¬∞C)</span><span class="diag-val" id="d_hydMtrTemp">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Controller Temp (¬∞C)</span><span class="diag-val" id="d_hydCtrlTemp">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Pump Status</span><span class="diag-val" id="d_pumpStatus">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Pump RPM</span><span class="diag-val" id="d_pumpRpm">‚Äì</span></div>
            </div>
            <div class="diag-group">
                <h3>System</h3>
                <div class="diag-item"><span class="diag-label">Slaves</span><span class="diag-val" id="d_slaves">‚Äì</span></div>
                <div class="diag-item"><span class="diag-label">Timestamp</span><span class="diag-val" id="d_ts">‚Äì</span></div>
            </div>
        </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- MAP SETUP ---
    const map = L.map('map', {zoomControl:true, maxZoom: 22, preferCanvas: true}).setView([16.05,80.35],15);
    
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxNativeZoom: 19, maxZoom: 22, attribution:'¬© OpenStreetMap'
    });
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxNativeZoom: 19, maxZoom: 22, attribution:'¬© Esri'
    });
    osmLayer.addTo(map);
    setTimeout(() => { map.invalidateSize(); }, 500);

    let isSatellite = false;
    const vehicleLayer = L.layerGroup().addTo(map); 
    
    const vehicleIcon = L.divIcon({
      className: 'vehicle-marker',
      html: `<div id="vehicle-arrow" style="transition: transform 0.3s ease;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="#06b6d4" stroke="#ffffff" stroke-width="2" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transform-origin: center;">
          <path d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" />
        </svg></div>`,
      iconSize: [40, 40], iconAnchor: [20, 20]
    });

    // --- STATE MANAGEMENT ---
    let marker = null; 
    let currentLatLng = null;
    let ws = null;
    let wsKeepAlive = null;
    let reconnectTimeout = null;
    let currentSegment = null;
    let lastPathPoint = null;
    let dashboardDate = new Date().toLocaleDateString();
    
    let selectedVehicle = "";
    let abortController = null;
    
    // --- Connection Status Tracking ---
    let lastMessageTime = 0;
    let lastMessageTimeFormatted = '--:--:--';
    let connectionStatusTimer = null;
    let disconnectTime = null;
    let lastDataValues = {
            speed: '‚Äì km/h',
            rpm: '‚Äì',
            odo: '‚Äì km',
            batEnergy: '‚Äì',
            mtrTemp: '‚Äì',
            ctrlTemp: '‚Äì',
            rmsCurr: '‚Äì',
            batVolt: '‚Äì',
            batCurr: '‚Äì',
            // New tracked states
            gear: '‚Äì',
            drive: '‚Äì',
            spray: 'OFF',
            mode: 'IDLE', 
            modeColor: '#1e293b'
        };
    const STATUS_TIMEOUT_DISCONNECT = 3000; // 3 seconds for orange
    const STATUS_TIMEOUT_OFFLINE = 30 * 60 * 1000; // 30 minutes for red

    // --- Helper function to get current time ---
    function formatTime(date) {
      return date.toLocaleTimeString();
    }

    // Helper: Only updates 'last' if 'curr' is valid (not null/undefined)
    function updateIfValid(key, value, formatter = (v) => v) {
        if (value !== null && value !== undefined) {
            lastDataValues[key] = formatter(value);
        }
    }

    // --- STATUS INDICATOR FUNCTION WITH TIME ---
    function updateConnectionStatus(status) {
      const indicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      const statusTime = document.getElementById('statusTime');
      
      indicator.classList.remove('connected', 'disconnected', 'offline');
      
      switch(status) {
        case 'connected':
          indicator.classList.add('connected');
          statusText.innerHTML = '‚úì Connected';
          statusTime.textContent = 'Last: ' + lastMessageTimeFormatted;
          reconnectBtn.classList.remove('visible');
          disconnectTime = null;
          break;
        case 'disconnected':
          indicator.classList.add('disconnected');
          statusText.innerHTML = '‚ö† Disconnected';
          statusTime.textContent = 'Last: ' + lastMessageTimeFormatted;
          reconnectBtn.classList.add('visible');
          break;
        case 'offline':
          indicator.classList.add('offline');
          statusText.innerHTML = '‚úï Offline';
          statusTime.textContent = 'Last: ' + lastMessageTimeFormatted;
          reconnectBtn.classList.add('visible');
          break;
      }
    }

    // Update status time display every second
    setInterval(() => {
      if(disconnectTime) {
        const statusTime = document.getElementById('statusTime');
        statusTime.textContent = 'Last: ' + lastMessageTimeFormatted;
      }
    }, 1000);

    function resetConnectionTimer() {
      lastMessageTime = Date.now();
      lastMessageTimeFormatted = new Date().toLocaleTimeString();
      updateConnectionStatus('connected');
      
      if(connectionStatusTimer) clearTimeout(connectionStatusTimer);
      
      connectionStatusTimer = setTimeout(() => {
        updateConnectionStatus('disconnected');
        
        setTimeout(() => {
          const timeSinceLastMessage = Date.now() - lastMessageTime;
          if(timeSinceLastMessage > STATUS_TIMEOUT_OFFLINE) {
            updateConnectionStatus('offline');
          }
        }, STATUS_TIMEOUT_DISCONNECT);
      }, STATUS_TIMEOUT_DISCONNECT);
    }

    // --- MODAL MANAGEMENT ---
    const modal = document.getElementById('diagModal');
    document.getElementById('openDiagBtn').onclick = () => modal.classList.add('open');
    document.getElementById('closeDiagBtn').onclick = () => modal.classList.remove('open');
    modal.onclick = (e) => { if(e.target === modal) modal.classList.remove('open'); };

    document.getElementById('downloadBtn').onclick = () => {
      const vehicleId = document.getElementById('vehicleSelect').value;
      window.location.href = `/download/${vehicleId}`;
    };

    document.getElementById('fullscreenBtn').addEventListener('click', () => {
        const mapEl = document.getElementById('map');
        if (mapEl.requestFullscreen) {
            if (!document.fullscreenElement) mapEl.requestFullscreen();
            else document.exitFullscreen();
        } else {
            if (mapEl.classList.contains('pseudo-fullscreen')) {
                mapEl.classList.remove('pseudo-fullscreen');
                setTimeout(() => map.invalidateSize(), 100);
            } else {
                mapEl.classList.add('pseudo-fullscreen');
                setTimeout(() => map.invalidateSize(), 100);
            }
        }
    });

    document.getElementById('screenshotBtn').addEventListener('click', () => {
        const btn = document.getElementById('screenshotBtn');
        const txt = btn.textContent; btn.textContent='‚è≥';
        html2canvas(document.getElementById('map'), {useCORS:true, allowTaint:true, logging:false, ignoreElements:(el)=>el.classList.contains('map-tools')||el.classList.contains('map-controls')})
        .then(canvas=>{
            const link=document.createElement('a'); link.download=`Map_${Date.now()}.png`; link.href=canvas.toDataURL(); link.click(); btn.textContent=txt;
        });
    });

    // --- MATH HELPERS FOR SWATH ---
    function toRad(deg) { return deg * Math.PI / 180; }
    function toDeg(rad) { return rad * 180 / Math.PI; }
    
    function getBearing(lat1, lon1, lat2, lon2) {
        const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
        const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                  Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
        return toDeg(Math.atan2(y, x));
    }

    function getDestination(lat, lon, brng, dist) {
        const R = 6378137;
        const radDist = dist / R;
        const radLat = toRad(lat);
        const radLon = toRad(lon);
        const radBrng = toRad(brng);

        const newLat = Math.asin(Math.sin(radLat) * Math.cos(radDist) +
                        Math.cos(radLat) * Math.sin(radDist) * Math.cos(radBrng));
        const newLon = radLon + Math.atan2(Math.sin(radBrng) * Math.sin(radDist) * Math.cos(radLat),
                                Math.cos(radDist) - Math.sin(radLat) * Math.sin(newLat));
        return [toDeg(newLat), toDeg(newLon)];
    }

function addPointToPath(latlng, isSpraying, isFieldMode) {
        const sprayStatus = isSpraying ? 1 : 0;
        
        // 1. FILTER: Check distance from last point
        if (lastPathPoint) {
            // Calculate distance in meters
            const dist = haversineDistance(lastPathPoint[0], lastPathPoint[1], latlng[0], latlng[1]);
            
            // IF DISTANCE > 2 METERS: SKIP DRAWING LINE (break segment)
            if (dist > 30.0) {
                currentSegment = null; // Forces a new line strip to start
                lastPathPoint = latlng; // Update last point so we can resume from here
                return; // Stop processing this point for the path
            }
        }

        // LINE COLOR: GREEN for Field Mode, BLUE for Travel Mode
        const lineColor = isFieldMode ? '#22c55e' : '#06b6d4';

        // Create new segment if mode changed, color changed, or no segment exists
        if (!currentSegment || (currentSegment.options.color !== lineColor)) {
            currentSegment = L.polyline([latlng], {
                color: lineColor,
                weight: 4,
                opacity: 0.85
            }).addTo(vehicleLayer);
        } else {
            currentSegment.addLatLng(latlng);
        }

        // --- 5m SWATH SHADE: ONLY if Spray_Pump_Status === 1 ---
        if (sprayStatus === 1 && lastPathPoint) {
            const [pLat, pLon] = lastPathPoint;
            const [cLat, cLon] = latlng;

            if (pLat !== cLat || pLon !== cLon) {
                const bearing = getBearing(pLat, pLon, cLat, cLon);

                // Draw swath polygons
                const pLeft  = getDestination(pLat, pLon, bearing - 90, 5);
                const pRight = getDestination(pLat, pLon, bearing + 90, 5);
                const cLeft  = getDestination(cLat, cLon, bearing - 90, 5);
                const cRight = getDestination(cLat, cLon, bearing + 90, 5);

                L.polygon([pLeft, pRight, cRight, cLeft], {
                    color: '#22c55e',
                    fillColor: '#22c55e',
                    weight: 0,
                    fillOpacity: 0.25
                }).addTo(vehicleLayer);
            }
        }

        lastPathPoint = latlng;
    }

    function clearAllDashboard() {
        vehicleLayer.clearLayers();
        marker = null;
        currentSegment = null; 
        currentLatLng = null;
        lastPathPoint = null;
        lastDataValues = {
            speed: '‚Äì km/h',
            rpm: '‚Äì',
            odo: '‚Äì km',
            batEnergy: '‚Äì',
            mtrTemp: '‚Äì',
            ctrlTemp: '‚Äì',
            rmsCurr: '‚Äì',
            batVolt: '‚Äì',
            batCurr: '‚Äì'
        };

        document.getElementById('socFill').style.width = '0%';
        document.getElementById('socText').textContent = '‚Äì';
        document.getElementById('batEnergy').textContent = '‚Äì';
        document.getElementById('modeBadge').textContent = 'IDLE';
        document.getElementById('modeBadge').style.background = '#1e293b';
        document.getElementById('gearText').textContent = '‚Äì';
        document.getElementById('sprayText').textContent = '‚Äì';
        document.getElementById('sprayText').style.color = 'var(--muted)';
        document.getElementById('speed').textContent = '‚Äì km/h';
        document.getElementById('rpm').textContent = '‚Äì';
        document.getElementById('gpsDist').textContent = '‚Äì km';
        document.getElementById('sprayDist').textContent = '‚Äì km';
        document.getElementById('odo').textContent = '‚Äì km';
        document.getElementById('drive').textContent = '‚Äì';
        document.getElementById('lastUpdate').textContent = '‚Äì';
    }

    function safeGet(obj, ...keys){ 
        for(const k of keys){ 
            if(obj && (k in obj)) return obj[k]; 
        } 
        return undefined; 
    }

    function getValueInsensitive(obj, ...keys) { 
        if(!obj) return undefined; 
        for(const k of keys){ 
            if(k in obj) return obj[k]; 
        } 
        const kL=keys.map(k=>k.toLowerCase()); 
        for(const k of Object.keys(obj)){ 
            if(kL.includes(k.toLowerCase())) return obj[k]; 
        } 
        return undefined; 
    }

    function formatValue(value, fallback, suffix = '') {
      if(value === null || value === undefined) return fallback || '‚Äì';
      if(typeof value === 'number') return value.toString() + suffix;
      return value.toString() + suffix;
    }

function updateDiagnostics(sig, ts) {
        // --- Motor ---
        updateIfValid('mtrTemp', safeGet(sig,'Tr_Mtr_Temp'), v => Number(v).toFixed(1) + ' ¬∞C');
        updateIfValid('mtrRpm', safeGet(sig,'Motor_Rpm') || safeGet(sig,'RPM'));
        updateIfValid('rmsCurr', safeGet(sig,'Mtr_RMS_currents'), v => Number(v).toFixed(1) + ' A');
        updateIfValid('mtrEff', safeGet(sig, 'Motor_ctrl_efficiency'));
        updateIfValid('acc', safeGet(sig, 'Vehicle_Acceleration'));

        // --- Controller ---
        updateIfValid('ctrlTemp', safeGet(sig,'Ctrl_Temperature'), v => Number(v).toFixed(1) + ' ¬∞C');
        updateIfValid('ctrlVolt', safeGet(sig,'Ctrl_Bat_Voltage'), v => Number(v).toFixed(1) + ' V');
        updateIfValid('ctrlCurr', safeGet(sig,'Ctrl_Bat_Current'), v => Number(v).toFixed(1) + ' A');
        updateIfValid('dcVolt', safeGet(sig, 'DC_voltage'), v => Number(v).toFixed(1) + ' V');

        // --- Battery ---
        updateIfValid('batVolt', safeGet(sig,'BatteryVoltage'), v => Number(v).toFixed(1) + ' V');
        updateIfValid('batCurr', safeGet(sig,'Battery_current'), v => Number(v).toFixed(1) + ' A');
        updateIfValid('netCurr', safeGet(sig, 'Current'), v => Number(v).toFixed(1) + ' A');
        updateIfValid('energy', safeGet(sig, 'BatteryEnergy'), v => Number(v).toFixed(0) + ' Wh');
        
        const socVal = safeGet(sig,'ActualSOCPercentage') || safeGet(sig,'RSOC') || safeGet(sig,'SOC');
        updateIfValid('soc', socVal, v => v + ' %');

        // --- Hydraulics ---
        updateIfValid('hydMtrTemp', safeGet(sig,'hyd_Motor_temperature'), v => Number(v).toFixed(1) + ' ¬∞C');
        updateIfValid('hydCtrlTemp', safeGet(sig,'hyd_Controller_temperature'), v => Number(v).toFixed(1) + ' ¬∞C');
        updateIfValid('pumpRpm', safeGet(sig,'RPM')); // Assuming RPM in Hydraulics context if needed
        
        // Pump Status Logic (Hold previous state if null)
        const pStatus = safeGet(sig, 'Spray_Pump_Status');
        if (pStatus !== null && pStatus !== undefined) {
            document.getElementById('d_pumpStatus').textContent = (pStatus == 1) ? 'ON' : 'OFF';
        }
        
        // Update DOM elements using the HELD values
        document.getElementById('d_mtrTemp').textContent = lastDataValues.mtrTemp;
        document.getElementById('d_mtrRpm').textContent = lastDataValues.mtrRpm;
        document.getElementById('d_rmsCurr').textContent = lastDataValues.rmsCurr;
        document.getElementById('d_mtrEff').textContent = lastDataValues.mtrEff || '‚Äì';
        document.getElementById('d_acc').textContent = lastDataValues.acc || '‚Äì';
        
        document.getElementById('d_ctrlTemp').textContent = lastDataValues.ctrlTemp;
        document.getElementById('d_ctrlVolt').textContent = lastDataValues.ctrlVolt;
        document.getElementById('d_ctrlCurr').textContent = lastDataValues.ctrlCurr;
        document.getElementById('d_dcVolt').textContent = lastDataValues.dcVolt || '‚Äì';
        
        document.getElementById('d_batVolt').textContent = lastDataValues.batVolt;
        document.getElementById('d_batCurr').textContent = lastDataValues.batCurr;
        document.getElementById('d_netCurr').textContent = lastDataValues.netCurr || '‚Äì';
        document.getElementById('d_energy').textContent = lastDataValues.energy || '‚Äì';
        document.getElementById('d_soc').textContent = lastDataValues.soc || '‚Äì';
        
        document.getElementById('d_hydMtrTemp').textContent = lastDataValues.hydMtrTemp || '‚Äì';
        document.getElementById('d_hydCtrlTemp').textContent = lastDataValues.hydCtrlTemp || '‚Äì';
        document.getElementById('d_pumpRpm').textContent = lastDataValues.pumpRpm || '‚Äì';

        const timestamp = ts || new Date().getTime();
        const tsDate = new Date(timestamp > 1e10 ? timestamp : timestamp * 1000);
        document.getElementById('d_ts').textContent = tsDate.toLocaleString() || '‚Äì';
    }

function handleMessage(ev) {
        try {
            const data = JSON.parse(ev.data);
            if (data.vehicle_id && data.vehicle_id !== selectedVehicle) return;

            resetConnectionTimer();
            const today = new Date().toLocaleDateString();
            if (today !== dashboardDate) { clearAllDashboard(); dashboardDate = today; }

            const gnss = data.gnss || data.location || {};
            const sig = data.signals || data || {};
            const heading = data.vehicle_direction_deg || 0;
            const ts = data.timestamp || new Date().getTime();

            // 1. Update Diagnostics (uses sample & hold internally now)
            updateDiagnostics(sig, ts);

            // 2. Handle Map & Path
            const lat = safeGet(gnss, 'lat', 'latitude');
            const lon = safeGet(gnss, 'lon', 'longitude');
            
            // LOGIC FIX: Determine Spray/Field status with memory
            const sprayRaw = safeGet(sig, 'Spray_Pump_Status');
            if (sprayRaw !== null && sprayRaw !== undefined) {
                lastDataValues.isSpraying = (sprayRaw == 1 || sprayRaw == '1');
            }
            
            const fieldModeRaw = safeGet(sig, 'Field_Mode');
            if (fieldModeRaw !== null && fieldModeRaw !== undefined) {
                lastDataValues.isFieldMode = (fieldModeRaw == 1 || fieldModeRaw == '1');
            }

            // Use the HELD values for drawing
            const isSpraying = lastDataValues.isSpraying || false;
            const isFieldMode = lastDataValues.isFieldMode || false;

            if (typeof lat === 'number' && typeof lon === 'number') {
                const ll = [lat, lon]; 
                currentLatLng = ll;
                if (!marker) {
                    marker = L.marker(ll, {icon: vehicleIcon}).addTo(vehicleLayer);
                    map.setView(ll, 16);
                } else {
                    marker.setLatLng(ll);
                }
                const arrow = document.getElementById('vehicle-arrow');
                if (arrow) arrow.style.transform = `rotate(${heading}deg)`;
                
                // Pass the held state to path drawing
                addPointToPath(ll, isSpraying, isFieldMode);
            }

            // 3. Update Dashboard Cards (Sample & Hold)
            
            // SOC
            const soc = safeGet(sig, 'RSOC', 'ActualSocPercentage', 'SOC', 'ActualSOCPercentage');
            if (soc !== null && soc !== undefined) updateSOC(soc);

            updateIfValid('batEnergy', safeGet(sig, 'BatteryEnergy'), v => Number(v).toFixed(2));
            document.getElementById('batEnergy').textContent = lastDataValues.batEnergy;

            // Mode Badge Logic
            const fMode = safeGet(sig, 'Field_Mode');
            const tMode = safeGet(sig, 'Travel_Mode');
            
            // Only update mode if we received explicit data
            if (fMode !== null || tMode !== null) {
                if (fMode == 1) { 
                    lastDataValues.mode = "FIELD MODE"; lastDataValues.modeColor = "var(--success)";
                } else if (tMode == 1) { 
                    lastDataValues.mode = "TRAVEL MODE"; lastDataValues.modeColor = "var(--warn)";
                } else {
                    // Only switch to IDLE if we received 0 for both (and they are not null)
                    if (fMode == 0 && tMode == 0) {
                        lastDataValues.mode = "IDLE"; lastDataValues.modeColor = "#1e293b";
                    }
                }
            }
            const badge = document.getElementById('modeBadge');
            badge.textContent = lastDataValues.mode; 
            badge.style.background = lastDataValues.modeColor;

            // Gear Logic
            const gLow = safeGet(sig, 'Gear_Low');
            const gHigh = safeGet(sig, 'Gear_High');
            if (gLow == 1) lastDataValues.gear = "L";
            else if (gHigh == 1) lastDataValues.gear = "H";
            else if (gLow === 0 && gHigh === 0) lastDataValues.gear = "N"; 
            // If both are null, lastDataValues.gear remains unchanged
            document.getElementById('gearText').textContent = lastDataValues.gear;

            // Speed & Odo
            updateIfValid('speed', safeGet(sig, 'Speed'), v => Number(v).toFixed(1) + ' km/h');
            document.getElementById('speed').textContent = lastDataValues.speed;

            updateIfValid('rpm', safeGet(sig, 'RPM'));
            document.getElementById('rpm').textContent = lastDataValues.rpm;

            updateIfValid('odo', safeGet(sig, 'Main_Odometer'), v => Number(v).toFixed(1) + ' km');
            document.getElementById('odo').textContent = lastDataValues.odo;

            // Spray Status Text
            if (sprayRaw !== null && sprayRaw !== undefined) {
                lastDataValues.spray = (sprayRaw == 1) ? "ON" : "OFF";
                lastDataValues.sprayColor = (sprayRaw == 1) ? 'var(--success)' : 'var(--muted)';
            }
            const sprayTxt = document.getElementById('sprayText');
            sprayTxt.textContent = lastDataValues.spray;
            sprayTxt.style.color = lastDataValues.sprayColor || 'var(--muted)';

            // Drive Logic
            const dFwd = safeGet(sig, 'Drive_Forward');
            const dRev = safeGet(sig, 'Drive_Reverse');
            if (dFwd == 1) lastDataValues.drive = "D";
            else if (dRev == 1) lastDataValues.drive = "R";
            else if (dFwd === 0 && dRev === 0) lastDataValues.drive = "N";
            document.getElementById('drive').textContent = lastDataValues.drive;

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

        } catch (e) {
            console.error("Message handling error:", e);
        }
    }


    const vehicleSelect = document.getElementById('vehicleSelect');
    const reconnectBtn = document.getElementById('reconnectBtn');
    
function connectVehicle(vid) {
       if(ws) { ws.close(); clearInterval(wsKeepAlive); }
       if(reconnectTimeout) clearTimeout(reconnectTimeout);
       if(connectionStatusTimer) clearTimeout(connectionStatusTimer);
       
       if(abortController) abortController.abort();
       abortController = new AbortController();
       
       selectedVehicle = vid;
       clearAllDashboard();
       updateConnectionStatus('disconnected');
       
       // Initialize with empty but valid structure
       lastDataValues = {
           speed: '‚Äì km/h',
           rpm: '‚Äì',
           odo: '‚Äì km',
           batEnergy: '‚Äì',
           mtrTemp: '‚Äì',
           ctrlTemp: '‚Äì',
           rmsCurr: '‚Äì',
           batVolt: '‚Äì',
           batCurr: '‚Äì'
       };
       
       // FETCH HISTORY
       fetch(`/history/${vid}`, { signal: abortController.signal })
         .then(r=>r.json())
         .then(d=>{
           if(selectedVehicle !== vid) return;
           if(d.path && d.path.length){
               d.path.forEach(pt => {
                   const ll = [pt[0], pt[1]];
                   
                   // pt[2] = spray_pump_status (1 = spraying, 0 = not spraying)
                   const isSpraying = (pt[2] == 1);
                   
                   // FIX: Use pt[3] for Field Mode (1 = Field, 0 = Travel)
                   // Your Python sends: [lat, lon, spray, field_mode]
                   const isFieldMode = (pt[3] == 1); 

                   addPointToPath(ll, isSpraying, isFieldMode);
                   
                   // Update marker position without drawing line if it jumped
                   currentLatLng = ll;
               });
               
               if(currentLatLng) { 
                   marker = L.marker(currentLatLng, {icon:vehicleIcon}).addTo(vehicleLayer);
                   map.setView(currentLatLng, 16); 
               }
           }
           if(d.gps_distance_km !== undefined) document.getElementById('gpsDist').textContent = d.gps_distance_km + ' km';
           if(d.spray_distance_km !== undefined) document.getElementById('sprayDist').textContent = d.spray_distance_km + ' km';
       }).catch(e => {
           if (e.name !== 'AbortError') console.error("History fetch failed:", e);
       });

       // ... (Rest of WebSocket connection code remains same) ...
       const proto = (location.protocol==='https:')?'wss:':'ws:';
       ws = new WebSocket(`${proto}//${location.host}/ws/vehicle/${vid}`);
       
       ws.onopen = () => {
           if(selectedVehicle === vid) {
             resetConnectionTimer();
             wsKeepAlive = setInterval(()=>{ if(ws && ws.readyState===1) ws.send('ping'); }, 30000);
           }
       };
       ws.onclose = () => {
           if(selectedVehicle === vid) {
             updateConnectionStatus('disconnected');
             reconnectTimeout = setTimeout(() => { if(selectedVehicle === vid && ws && ws.readyState===3) connectVehicle(vid); }, 5000);
           }
       };
       ws.onerror = (error) => { 
           if(selectedVehicle === vid) updateConnectionStatus('disconnected');
       };
       ws.onmessage = handleMessage;
    }

    vehicleSelect.addEventListener('change', (e)=>{ connectVehicle(e.target.value); });
    reconnectBtn.addEventListener('click', () => { connectVehicle(vehicleSelect.value); });
    connectVehicle(vehicleSelect.value);

    document.getElementById('focusBtn').onclick = () => { if(currentLatLng) map.setView(currentLatLng, 17); };
    document.getElementById('navBtn').onclick = () => { if(currentLatLng) window.open(`https://www.google.com/maps/dir/?api=1&destination=${currentLatLng[0]},${currentLatLng[1]}`); };
    document.getElementById('satelliteBtn').onclick = () => {
        if(isSatellite){ map.removeLayer(satelliteLayer); map.addLayer(osmLayer); isSatellite=false; }
        else{ map.removeLayer(osmLayer); map.addLayer(satelliteLayer); isSatellite=true; }
    };

    function updateSOC(val){
      const pct = Math.max(0,Math.min(100,Math.round(Number(val)||0)));
      const fill = document.getElementById('socFill');
      fill.style.width = pct + '%'; 
      document.getElementById('socText').textContent = pct + '%';
      if(pct>=75) fill.style.background='var(--success)'; 
      else if(pct>=40) fill.style.background='var(--warn)'; 
      else fill.style.background='var(--danger)';
    }

// --- LAND MEASUREMENT SYSTEM ---
    let isLandMeasuring = false;
    let landMeasurePoints = [];
    let landMeasureMarkers = [];
    let landMeasurePolyline = null;
    let landMeasurePolygon = null;

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function calculatePolygonArea(points) {
      if (points.length < 3) return 0;
      const originLat = points[0][0]; 
      const originLon = points[0][1];
      const R = 6378137;
      const degToRad = Math.PI / 180;
      const metersPerLat = R * degToRad; 
      const metersPerLon = R * degToRad * Math.cos(originLat * degToRad);

      const xyPoints = points.map(pt => {
        const dLat = pt[0] - originLat;
        const dLon = pt[1] - originLon;
        return {
            x: dLon * metersPerLon,
            y: dLat * metersPerLat
        };
      });

      let area = 0;
      for (let i = 0; i < xyPoints.length; i++) {
        const j = (i + 1) % xyPoints.length;
        area += xyPoints[i].x * xyPoints[j].y;
        area -= xyPoints[j].x * xyPoints[i].y;
      }
      area = Math.abs(area) / 2.0;
      return area;
    }

    function updateLandMeasurements() {
      if (landMeasurePoints.length === 0) {
        document.getElementById('landStatsContainer').style.display = 'none';
        document.getElementById('landClearBtn').disabled = true;
        document.getElementById('landUndoBtn').disabled = true;
        return;
      }

      document.getElementById('landStatsContainer').style.display = 'block';
      document.getElementById('landClearBtn').disabled = false;
      document.getElementById('landUndoBtn').disabled = false;

      const areaM2 = calculatePolygonArea(landMeasurePoints);
      const areaAcres = areaM2 / 4046.86;
      
      document.getElementById('landAreaVal').textContent = areaAcres.toFixed(3) + ' acres';
      document.getElementById('landAreaSqm').textContent = areaM2.toFixed(0) + ' m¬≤';
      document.getElementById('landPointsVal').textContent = landMeasurePoints.length;

      const pointsList = document.getElementById('landPointsList');
      pointsList.innerHTML = '';
      landMeasurePoints.forEach((pt, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'padding: 6px; background: rgba(255,255,255,0.03); border-left: 2px solid #06b6d4; border-radius: 2px; font-size: 10px; margin-bottom: 4px;';
        div.innerHTML = `<div style="color: #9aa4b2; font-size: 9px;">P${i + 1}</div><div style="color: white; font-size: 11px; font-weight: 600;">${pt[0].toFixed(6)}, ${pt[1].toFixed(6)}</div>`;
        pointsList.appendChild(div);
      });
    }

    function addLandMeasurePoint(latlng) {
      const point = [latlng.lat, latlng.lng];
      landMeasurePoints.push(point);

      const marker = L.circleMarker(latlng, {
        radius: 6,
        fillColor: '#f59e0b',
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(vehicleLayer).bindPopup(`Land Point ${landMeasurePoints.length}`);

      landMeasureMarkers.push(marker);

      if (landMeasurePolyline) {
        map.removeLayer(landMeasurePolyline);
      }
      landMeasurePolyline = L.polyline(landMeasurePoints, {
        color: '#f59e0b',
        weight: 2,
        opacity: 0.7,
        dashArray: '4, 4'
      }).addTo(vehicleLayer);

      if (landMeasurePoints.length >= 3) {
        if (landMeasurePolygon) {
          map.removeLayer(landMeasurePolygon);
        }
        landMeasurePolygon = L.polygon(landMeasurePoints, {
          color: '#f59e0b',
          weight: 2,
          opacity: 0.6,
          fillColor: '#f59e0b',
          fillOpacity: 0.15
        }).addTo(vehicleLayer);
      }

      updateLandMeasurements();
    }

    document.getElementById('landMeasureBtn').addEventListener('click', () => {
      isLandMeasuring = !isLandMeasuring;
      const btn = document.getElementById('landMeasureBtn');
      btn.style.background = isLandMeasuring ? 'var(--success)' : '#374151';
      btn.textContent = isLandMeasuring ? '‚èπÔ∏è Stop Measuring' : 'üìê Measure Land';
    });

    map.on('click', (e) => {
      if (isLandMeasuring) {
        addLandMeasurePoint(e.latlng);
      }
    });

    document.getElementById('landClearBtn').addEventListener('click', () => {
      landMeasurePoints = [];
      landMeasureMarkers.forEach(m => vehicleLayer.removeLayer(m));
      landMeasureMarkers = [];
      if (landMeasurePolyline) vehicleLayer.removeLayer(landMeasurePolyline);
      if (landMeasurePolygon) vehicleLayer.removeLayer(landMeasurePolygon);
      landMeasurePolyline = null;
      landMeasurePolygon = null;
      updateLandMeasurements();
    });

    document.getElementById('landUndoBtn').addEventListener('click', () => {
      if (landMeasurePoints.length > 0) {
        landMeasurePoints.pop();
        const marker = landMeasureMarkers.pop();
        vehicleLayer.removeLayer(marker);

        if (landMeasurePolyline) {
          vehicleLayer.removeLayer(landMeasurePolyline);
          landMeasurePolyline = null;
        }
        if (landMeasurePolygon) {
          vehicleLayer.removeLayer(landMeasurePolygon);
          landMeasurePolygon = null;
        }

        if (landMeasurePoints.length > 0) {
          landMeasurePolyline = L.polyline(landMeasurePoints, {
            color: '#f59e0b',
            weight: 2,
            opacity: 0.7,
            dashArray: '4, 4'
          }).addTo(vehicleLayer);

          if (landMeasurePoints.length >= 3) {
            landMeasurePolygon = L.polygon(landMeasurePoints, {
              color: '#f59e0b',
              weight: 2,
              opacity: 0.6,
              fillColor: '#f59e0b',
              fillOpacity: 0.15
            }).addTo(vehicleLayer);
          }
        }

        updateLandMeasurements();
      }
    });
  </script>
</body>
</html>